<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formul√°rio de Entrega de Pe√ßas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; padding: 10px; }
    h1 { text-align: center; margin-bottom: 20px; font-size: 1.5em; }

    form {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: auto;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"], input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .input-group {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .input-group input {
      flex: 1 1 auto;
    }

    .input-group button {
      flex: 0 0 auto;
      padding: 10px;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1em;
      cursor: pointer;
    }

    button:hover { background: #0056b3; }

    table {
      width: 100%;
      border-collapse: collapse;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
      margin-bottom: 10px;
    }

    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    canvas {
      width: 100%;
      max-width: 400px;
      aspect-ratio: 2 / 1;
      display: block;
      margin: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #camera-preview-codigoPeca,
    #camera-preview-serialProxxi,
    #camera-preview-notaFiscal {
      width: 100%;
      max-width: 400px;
      aspect-ratio: 1 / 1;
      margin: auto;
    }

    footer {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background: #f0f0f0;
      font-size: 0.8em;
    }

    @media (max-width: 375px) {
      h1 { font-size: 1.2em; }
      form { padding: 15px; }
      input, button { font-size: 0.9em; padding: 8px; }
    }

    @media (orientation: landscape) {
      form { padding: 10px 30px; }
    }
  </style>
</head>
<body>
  <h1>Formul√°rio de Entrega de Pe√ßas</h1>

  <form id="deliveryForm">
    <label for="data">Data:</label>
    <input type="date" id="data" name="data" required />

    <label for="nomeRecebedor">Nome do Recebedor:</label>
    <input type="text" id="nomeRecebedor" name="nomeRecebedor" required />

    <label for="nomeTecnico">Nome T√©cnico:</label>
    <input type="text" id="nomeTecnico" name="nomeTecnico" required />

    <h3>C√≥digo, N√∫mero de S√©rie, Nota Fiscal:</h3>
    <table id="serialTable">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>N√∫mero de S√©rie</th>
          <th>Nota Fiscal</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="input-group">
      <input type="text" id="codigoPeca" placeholder="C√≥digo da Pe√ßa" />
      <button type="button" onclick="iniciarLeituraCodigo('codigoPeca')">üì∑ Ler</button>
    </div>
    <div id="camera-preview-codigoPeca"></div>

    <div class="input-group">
      <input type="text" id="serialProxxi" placeholder="N√∫mero de S√©rie" />
      <button type="button" onclick="iniciarLeituraCodigo('serialProxxi')">üì∑ Ler</button>
    </div>
    <div id="camera-preview-serialProxxi"></div>

    <div class="input-group">
      <input type="text" id="notaFiscal" placeholder="Nota Fiscal" />
      <button type="button" onclick="iniciarLeituraCodigo('notaFiscal')">üì∑ Ler</button>
    </div>
    <div id="camera-preview-notaFiscal"></div>

    <button type="button" onclick="addRow()">Adicionar</button>

    <label for="assinatura">Assinatura Recebedor:</label>
    <canvas id="signatureCanvas" width="300" height="150"></canvas>
    <button type="button" onclick="limparAssinatura()">Limpar Assinatura</button>

    <button type="button" onclick="gerarPDF()">Gerar PDF</button>
  </form>

  <footer>&copy; 2024 Diego Sakai & Cl√°udio Henrique. Todos os direitos reservados.</footer>

  <script>
    const { jsPDF } = window.jspdf;
    var canvas = document.getElementById("signatureCanvas");
    var ctx = canvas.getContext("2d");
    var isDrawing = false;
    const leitoresAtivos = {};

    function iniciarLeituraCodigo(idInput) {
      const previewDiv = document.getElementById(`camera-preview-${idInput}`);
      if (leitoresAtivos[idInput]) {
        leitoresAtivos[idInput].stop();
        leitoresAtivos[idInput].clear();
      }

      const html5QrCode = new Html5Qrcode(previewDiv.id);
      leitoresAtivos[idInput] = html5QrCode;

      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          let cam = devices[0].id;
          const backCam = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('traseira'));
          if (backCam) cam = backCam.id;

          html5QrCode.start(
            cam,
            { fps: 10, qrbox: { width: 250, height: 250 } },
            decodedText => {
              document.getElementById(idInput).value = decodedText;
              html5QrCode.stop().then(() => {
                html5QrCode.clear();
                delete leitoresAtivos[idInput];
              });
            },
            errorMsg => {}
          );
        } else {
          alert("Nenhuma c√¢mera encontrada.");
        }
      }).catch(err => {
        alert("Erro ao acessar c√¢mera: " + err);
      });
    }

    function addRow() {
      var c = document.getElementById("codigoPeca").value;
      var s = document.getElementById("serialProxxi").value;
      var n = document.getElementById("notaFiscal").value;
      if (c && s && n) {
        var row = document.getElementById("serialTable").getElementsByTagName("tbody")[0].insertRow();
        row.insertCell(0).textContent = c;
        row.insertCell(1).textContent = s;
        row.insertCell(2).textContent = n;
        var actions = row.insertCell(3);
        var e = document.createElement("button"); e.textContent = "Editar"; e.onclick = () => editarLinha(row); actions.appendChild(e);
        var d = document.createElement("button"); d.textContent = "Excluir"; d.onclick = () => excluirLinha(row); actions.appendChild(d);
        document.getElementById("codigoPeca").value = "";
        document.getElementById("serialProxxi").value = "";
        document.getElementById("notaFiscal").value = "";
      }
    }

    function editarLinha(linha) {
      document.getElementById("codigoPeca").value = linha.cells[0].textContent;
      document.getElementById("serialProxxi").value = linha.cells[1].textContent;
      document.getElementById("notaFiscal").value = linha.cells[2].textContent;
      linha.remove();
    }

    function excluirLinha(linha) { linha.remove(); }

    function limparAssinatura() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    function gerarPDF() {
      var doc = new jsPDF();
      doc.setFontSize(20).text("Formul√°rio de Entrega de Pe√ßas", 105, 20, { align: "center" });
      doc.setFontSize(12);
      doc.text(`Data: ${document.getElementById("data").value}`, 20, 40);
      doc.text(`Nome do Recebedor: ${document.getElementById("nomeRecebedor").value}`, 20, 50);
      doc.text(`Nome T√©cnico: ${document.getElementById("nomeTecnico").value}`, 20, 60);

      var tableData = [];
      var rows = document.getElementById("serialTable").getElementsByTagName("tbody")[0].rows;
      for (var i = 0; i < rows.length; i++) {
        tableData.push([
          rows[i].cells[0].textContent,
          rows[i].cells[1].textContent,
          rows[i].cells[2].textContent
        ]);
      }
      doc.autoTable({ head: [["C√≥digo", "N√∫mero de S√©rie", "Nota Fiscal"]], body: tableData, startY: 70 });
      var imgData = canvas.toDataURL("image/png");
      doc.addImage(imgData, "PNG", 15, doc.autoTable.previous.finalY + 10, 180, 90);
      doc.save("form_entrega_pecas.pdf");
    }

    canvas.addEventListener("mousedown", startDrawing);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", stopDrawing);
    canvas.addEventListener("mouseout", stopDrawing);
    canvas.addEventListener("touchstart", startDrawing);
    canvas.addEventListener("touchmove", draw);
    canvas.addEventListener("touchend", stopDrawing);
    canvas.addEventListener("touchcancel", stopDrawing);

    function getPos(e) {
      var r = canvas.getBoundingClientRect();
      return {
        x: ((e.clientX || e.touches[0].clientX) - r.left) / r.width * canvas.width,
        y: ((e.clientY || e.touches[0].clientY) - r.top) / r.height * canvas.height
      };
    }
    function startDrawing(e) { isDrawing = true; var p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); }
    function draw(e) { if (!isDrawing) return; var p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }
    function stopDrawing(e) { if (isDrawing) { ctx.stroke(); ctx.closePath(); isDrawing = false; } e.preventDefault(); }
  </script>
</body>
</html>
